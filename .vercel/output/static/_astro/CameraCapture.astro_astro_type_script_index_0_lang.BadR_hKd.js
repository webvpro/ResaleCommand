import{s as c}from"./inventory.0Q6N9gdl.js";import"./appwrite.Cu45kNVr.js";window.parsePrice=function(s){if(!s)return 0;const e=s.match(/[0-9.]+/g);if(!e||e.length===0)return 0;if(e.length>=2){const t=parseFloat(e[0]),i=parseFloat(e[1]);return(t+i)/2}return parseFloat(e[0])||0};document.addEventListener("alpine:init",()=>{Alpine.data("profitCalculator",s=>({salePrice:s||0,shipping:10,feePercent:13,targetProfit:15,maxBuyPrice:0,init(){this.calculate(),this.$watch("salePrice",()=>this.calculate())},calculate(){const t=this.salePrice*(this.feePercent/100)+this.shipping+this.targetProfit,i=this.salePrice-t;this.maxBuyPrice=i>0?i:0,this.$dispatch("max-buy-update",{value:this.maxBuyPrice}),this.$dispatch("resale-price-update",{value:this.salePrice})}})),Alpine.data("cameraAnalysis",()=>({mode:"speed",images:[],imageFiles:[],userNotes:"",paidPrice:"",purchaseLocation:"",binLocation:"",receiptFile:null,gettingLocation:!1,loading:!1,result:null,isDragging:!1,isCameraOpen:!1,stream:null,currentFacingMode:"environment",switchCamera(){this.currentFacingMode=this.currentFacingMode==="environment"?"user":"environment",this.stopCamera(),this.startCamera()},getLocation(){if(!navigator.geolocation){alert("Geolocation is not supported by your browser");return}this.gettingLocation=!0,navigator.geolocation.getCurrentPosition(async s=>{const{latitude:e,longitude:t}=s.coords;try{const r=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e}&lon=${t}`)).json();if(r&&r.address){const a=r.address,o=[];a.shop?o.push(a.shop):a.amenity?o.push(a.amenity):a.tourism?o.push(a.tourism):a.leisure?o.push(a.leisure):a.office&&o.push(a.office),a.road&&o.push(a.road),(a.city||a.town||a.village||a.suburb)&&o.push(a.city||a.town||a.village||a.suburb),o.length>0?this.purchaseLocation=o.join(", "):this.purchaseLocation=r.display_name||`${e}, ${t}`}else this.purchaseLocation=`${e.toFixed(5)}, ${t.toFixed(5)}`}catch(i){console.error("Geocoding error:",i),this.purchaseLocation=`${e.toFixed(5)}, ${t.toFixed(5)}`}finally{this.gettingLocation=!1}},s=>{console.error(s),alert("Unable to retrieve location. Check browser permissions."),this.gettingLocation=!1},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})},async handleFileUpload(s){const e=s.target.files;!e||e.length===0||(await this.processFiles(e),this.result=null,this.$refs.fileInput&&(this.$refs.fileInput.value=""))},async handleDrop(s){this.isDragging=!1;const e=s.dataTransfer.files;if(e&&e.length>0){await this.processFiles(e);return}const t=s.dataTransfer.getData("text/uri-list")||s.dataTransfer.getData("text/plain");if(t&&(console.log("Dropped URL:",t),this.purchaseLocation=t,t.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i)))try{const i=await fetch(t);if(i.ok){const r=await i.blob(),a=new File([r],"dragged_image.jpg",{type:r.type});await this.processFiles([a])}else alert("Captured URL, but could not download image due to site security. Please save image and upload, or take a screenshot.")}catch(i){console.warn("Could not fetch dropped image URL:",i),alert("Captured URL for records, but could not process image directly (CORS locked).")}},async processFiles(s){for(let e=0;e<s.length;e++){if(this.images.length>=5){alert("Maximum 5 images allowed.");break}const t=s[e];if(!t.type.startsWith("image/"))continue;const i=await this.resizeImageFromFile(t);this.images.push(i),this.imageFiles.push(t)}},async resizeImageFromFile(s){return new Promise(e=>{const t=new FileReader;t.onload=i=>{const r=new Image;r.onload=()=>{const a=document.createElement("canvas"),o=800;let n=r.width,l=r.height;n>o&&(l*=o/n,n=o),a.width=n,a.height=l,a.getContext("2d").drawImage(r,0,0,n,l),e(a.toDataURL("image/jpeg",.7))},r.src=i.target.result},t.readAsDataURL(s)})},async startCamera(){try{this.isCameraOpen=!0,this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.currentFacingMode}}),this.$refs.videoPreview.srcObject=this.stream}catch(s){console.error("Camera Error:",s),alert("Could not access camera. Please allow permissions."),this.isCameraOpen=!1}},stopCamera(){this.stream&&(this.stream.getTracks().forEach(s=>s.stop()),this.stream=null),this.isCameraOpen=!1},capturePhoto(){if(!this.stream)return;if(this.images.length>=5){alert("Maximum 5 images allowed.");return}const s=this.$refs.videoPreview,e=document.createElement("canvas"),t=800;let i=s.videoWidth,r=s.videoHeight;i>t&&(r*=t/i,i=t),e.width=i,e.height=r,e.getContext("2d").drawImage(s,0,0,i,r);const o=e.toDataURL("image/jpeg",.7);this.images.push(o),e.toBlob(n=>{const l=new File([n],`capture_${Date.now()}.jpg`,{type:"image/jpeg"});this.imageFiles.push(l)},"image/jpeg",.7)},removeImage(s){this.images.splice(s,1),this.imageFiles.splice(s,1),this.result=null},clearAllImages(){this.images=[],this.imageFiles=[],this.result=null,this.stopCamera(),this.$refs.fileInput&&(this.$refs.fileInput.value="")},async analyzeImage(){if(this.images.length===0){alert("No images selected!");return}this.loading=!0;const s=JSON.stringify({images:this.images,notes:this.userNotes});console.log("Preparing to send. Payload length:",s.length);try{const e=await fetch("/api/identify-item",{method:"PUT",headers:{"Content-Type":"application/json","X-Client-Claim":"Using PUT to bypass proxy"},body:s});if(console.log("Server responded with status:",e.status),!e.ok){const t=await e.text();console.error("Server Error Headers:",[...e.headers.entries()]),console.error("Server Error Body:",t);let i;try{i=JSON.parse(t)}catch{i={error:t}}throw console.error("Full Error Details:",i),alert(`Server Error: ${i.details||i.error}`),new Error(i.details||i.error||"Analysis failed")}this.result=await e.json(),this.result&&!this.result.items&&(this.result.identity||this.result.title)&&(this.result={items:[{...this.result}]})}catch(e){console.error("Camera Analysis Error:",e),alert(`Error: ${e.message}`)}finally{this.loading=!1}},async saveToInventory(s,e){try{const t=e||this.$el,i=t.innerText;t.innerText="Saving...",t.disabled=!0;const r=this.imageFiles[0],a=this.imageFiles.slice(1);await c(s||this.result,r,{paidPrice:this.paidPrice,purchaseLocation:this.purchaseLocation,maxBuyPrice:s.maxBuyPrice?.toString()||"0",resalePrice:s.resalePrice?.toString()||"0",binLocation:this.binLocation,receiptFile:this.receiptFile,status:this.mode==="speed"?"in_cart":"need_to_list",galleryFiles:a}),alert("Success! Item saved to Inventory."),t.innerText="Saved!",t.classList.remove("btn-success"),t.classList.add("btn-disabled")}catch(t){console.error(t),alert(`Save Failed: ${t.message}. 

Check if you created the Database/Collection in Appwrite and added IDs to .env`);const i=e||this.$el;i.innerText="Save to Inventory",i.disabled=!1}}}))});
