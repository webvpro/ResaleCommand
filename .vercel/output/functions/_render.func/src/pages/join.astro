---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Joining Team...">
  <div class="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12 sm:px-6 lg:px-8" x-data="joinTeam">
    <div class="w-full max-w-md space-y-8 text-center">
      <h2 class="mt-6 text-3xl font-bold tracking-tight text-gray-900">Joining Team...</h2>
      <div x-show="loading" class="loading loading-spinner loading-lg text-primary"></div>
      <div x-show="error" class="text-red-500" x-text="error"></div>
      <div x-show="success" class="text-green-500">
        Successfully joined! Redirecting...
      </div>
    </div>
  </div>
</Layout>

<script>
  import { auth } from "../lib/auth";
  import Alpine from 'alpinejs';

  document.addEventListener('alpine:init', () => {
    Alpine.data('joinTeam', () => ({
      loading: true,
      error: '',
      success: false,

      async init() {
        const urlParams = new URLSearchParams(window.location.search);
        const teamId = urlParams.get('teamId');
        const membershipId = urlParams.get('membershipId');
        const userId = urlParams.get('userId');
        const secret = urlParams.get('secret');

        if (!teamId || !membershipId || !userId || !secret) {
          this.error = 'Invalid invitation link.';
          this.loading = false;
          return;
        }

        try {
          await auth.acceptInvite(teamId, membershipId, userId, secret);
          this.success = true;
          this.loading = false;
          // Refresh auth state ? The layout will re-init on navigation? 
          // We should redirect to home after a moment.
          setTimeout(() => {
             window.location.href = '/';
          }, 2000);
        } catch (err: any) {
          console.error(err);
          this.error = err.message || 'Failed to join team.';
          this.loading = false;
        }
      }
    }))
  })
</script>
