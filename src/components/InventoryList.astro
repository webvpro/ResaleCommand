---
import { getInventoryItems } from '../lib/inventory';

// Fetch items on server side
const allItems = await getInventoryItems();
const cartItems = allItems.filter((i: any) => i.status === 'in_cart');
// Group cart items by location
const cartGroups = cartItems.reduce((groups: any, item: any) => {
    const loc = item.purchaseLocation || 'Unknown Location';
    if (!groups[loc]) groups[loc] = [];
    groups[loc].push(item);
    return groups;
}, {});

// default to showing all others in inventory list (or just specific ones)
const inventoryItems = allItems.filter((i: any) => i.status !== 'in_cart');
---

<div class="space-y-12">
    
    <!-- SHOPPING CART SECTION -->
    {cartItems.length > 0 && (
        <div class="space-y-8">
            <h2 class="text-2xl font-bold flex items-center gap-2">üõí Active Shopping Cart <span class="badge badge-primary">{cartItems.length}</span></h2>

            {Object.entries(cartGroups).map(([location, groupItems]: [string, any[]]) => (
                <div class="bg-base-200 p-6 rounded-2xl border-2 border-base-300 relative">
                    <div class="absolute -top-3 left-6 px-2 bg-base-200 text-sm font-bold opacity-70 border border-base-300 rounded">
                        üìç {location} ({groupItems.length})
                    </div>
                
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-2">
                        {groupItems.map((item) => (
                            <div class="card bg-base-100 shadow-sm border-2 border-primary/20 hover:border-primary transition-colors">
                                <div class="card-body p-4">
                                    <div class="flex gap-4">
                                        <div class="w-16 h-16 bg-base-300 rounded-lg shrink-0 overflow-hidden">
                                            {item.imageId ? (
                                                <img src={`${import.meta.env.PUBLIC_APPWRITE_ENDPOINT}/storage/buckets/${import.meta.env.PUBLIC_APPWRITE_BUCKET_ID}/files/${item.imageId}/view?project=${import.meta.env.PUBLIC_APPWRITE_PROJECT_ID}`} class="w-full h-full object-cover" />
                                            ) : 'üì¶'}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-bold truncate">{item.title}</h3>
                                            <div class="text-xs opacity-70 mt-1">
                                                Max Buy: <span class="font-bold text-success">${item.maxBuyPrice}</span>
                                            </div>
                                            {item.binLocation && <div class="badge badge-xs badge-outline mt-1">{item.binLocation}</div>}
                                        </div>
                                    </div>
                                    <div class="card-actions justify-end mt-2">
                                        <button class="btn btn-sm btn-ghost text-error delete-btn" data-id={item.$id}>‚úï</button>
                                        <button class="btn btn-sm btn-primary purchase-btn" 
                                            data-id={item.$id} 
                                            data-title={item.title}>
                                            Purchase üí∏
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            ))}
        </div>
    )}

    <!-- MAIN INVENTORY SECTION -->
    <div>
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">In Inventory</h2>
        <span class="badge badge-lg">{inventoryItems.length} Items</span>
    </div>

    {inventoryItems.length === 0 ? (
        <div class="text-center py-12 bg-base-200 rounded-xl border-dashed border-2 border-base-300">
            <p class="text-lg opacity-60 mb-4">No items in inventory.</p>
        </div>
    ) : (
        <div class="grid grid-cols-2 min-[450px]:grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3">
            {inventoryItems.map((item) => (
                <div class="card bg-base-100 shadow-sm border border-base-200 hover:border-primary transition-colors group text-xs">
                    <figure class="aspect-square bg-base-200 relative overflow-hidden group-hover:opacity-90 transition-opacity">
                        {item.imageId ? (
                            <img 
                                src={`${import.meta.env.PUBLIC_APPWRITE_ENDPOINT}/storage/buckets/${import.meta.env.PUBLIC_APPWRITE_BUCKET_ID}/files/${item.imageId}/view?project=${import.meta.env.PUBLIC_APPWRITE_PROJECT_ID}`} 
                                alt={item.title} 
                                class="w-full h-full object-cover"
                            />
                        ) : (
                            <div class="flex items-center justify-center w-full h-full text-xl grayscale opacity-50">üì¶</div>
                        )}
                        <div class={`absolute top-0 right-0 p-1 badge rounded-none rounded-bl-lg badge-xs gap-1 font-bold ${
                            item.status === 'draft' ? 'badge-warning' :
                            item.status === 'need_to_list' ? 'badge-info' :
                            item.status === 'listed' ? 'badge-success' :
                            item.status === 'sold' ? 'badge-neutral' : ''
                        }`}>
                            {item.status ? item.status.replace(/_/g, ' ') : 'Draft'}
                        </div>
                    </figure>
                    <div class="card-body p-2 gap-0.5">
                        <h2 class="font-bold text-[11px] leading-tight line-clamp-2 h-[2.2em]">
                            {item.title || "Untitled"}
                        </h2>
                        
                        {item.binLocation && (
                            <div class="text-[9px] opacity-60 truncate">üìç {item.binLocation}</div>
                        )}
                        
                        <div class="flex justify-between items-end mt-1">
                            <div class="flex flex-col">
                                <span class="text-[9px] uppercase opacity-50 font-bold">Est</span>
                                <span class="text-xs font-bold text-success">
                                    {item.priceFair ? (item.priceFair.startsWith('$') ? item.priceFair : '$' + item.priceFair) : '-'}
                                </span>
                            </div>
                            <div class="flex flex-col text-right">
                                <span class="text-[9px] uppercase opacity-50 font-bold">Paid</span>
                                <span class="text-[10px] font-mono opacity-80">
                                    ${item.purchasePrice || '0'}
                                </span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-1 pt-1 border-t border-base-200">
                            <button class="btn btn-sm btn-square btn-ghost edit-btn" 
                                data-id={item.$id} 
                                data-title={item.title}
                                data-price={item.purchasePrice}
                                data-bin={item.binLocation}
                                data-status={item.status}
                                data-img={item.imageId}
                                data-gallery={JSON.stringify(item.galleryImageIds || [])}
                                data-description={item.marketDescription}
                            >
                                ‚úèÔ∏è
                            </button> 
                            <button 
                                class="btn btn-xs btn-ghost text-error delete-btn btn-square h-6 min-h-0 w-6" 
                                data-id={item.$id}
                                aria-label="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            ))}
        </div>
    )}
    </div>

    <!-- CHECKOUT MODAL -->
    <dialog id="checkout_modal" class="modal">
      <div class="modal-box">
        <!-- Form State -->
        <div id="checkout_form_wrapper">
            <h3 class="font-bold text-lg mb-4">Confirm Purchase</h3>
            <p>Purchasing: <span id="checkout_item_title" class="font-bold"></span></p>
            
            <div class="form-control w-full mt-4">
                <label class="label"><span class="label-text">Verify Price Paid</span></label>
                <input type="number" id="checkout_price" class="input input-bordered" placeholder="0.00" />
            </div>

            <div class="divider">Receipt</div>
            
            <div class="flex flex-col gap-2">
                <button id="checkout_camera_btn" class="btn btn-outline gap-2">
                    üì∑ Take Receipt Photo
                </button>
                <input type="file" id="checkout_file" accept="image/*" class="file-input file-input-bordered w-full" />
                
                <div id="checkout_preview" class="hidden w-full h-32 bg-base-200 rounded-lg mt-2 overflow-hidden">
                    <img id="checkout_preview_img" class="w-full h-full object-cover">
                </div>
                 <!-- Hidden Video Element for Camera -->
                 <video id="checkout_video" class="hidden w-full h-48 bg-black rounded-lg mt-2" autoplay playsinline></video>
                 <button id="checkout_capture_btn" class="hidden btn btn-success w-full mt-2">Capture</button>
            </div>

            <div class="modal-action">
              <form method="dialog">
                <button class="btn btn-ghost" id="checkout_cancel">Cancel</button>
              </form>
              <button id="checkout_confirm" class="btn btn-primary">Confirm Purchase</button>
            </div>
        </div>

        <!-- Result State -->
        <div id="checkout_result_wrapper" class="hidden">
            <h3 class="font-bold text-lg text-success mb-4">‚úÖ Purchase Confirmed!</h3>
            <p class="text-xs opacity-70 mb-4">The item has been moved to "Need to List".</p>
            
            <div class="divider">AI Description</div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Generated via Gemini</span>
                </label>
                <textarea id="generated_description" class="textarea textarea-bordered w-full h-64 font-mono text-xs" readonly placeholder="Generating description..."></textarea>
            </div>
            
            <div class="modal-action">
                 <button id="checkout_close_final" class="btn btn-primary w-full">Done</button>
            </div>
        </div>
      </div>
    </dialog>

    <!-- EDIT MODAL -->
    <dialog id="edit_modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Edit Item</h3>
        
        <div class="form-control w-full">
            <label class="label"><span class="label-text">Title</span></label>
            <input type="text" id="edit_title" class="input input-bordered w-full" />
        </div>
        
        <div class="flex gap-4 mt-4">
             <div class="form-control w-full">
                <label class="label"><span class="label-text">Paid Price</span></label>
                <input type="number" step="0.01" id="edit_price" class="input input-bordered w-full" />
            </div>
             <div class="form-control w-full">
                <label class="label"><span class="label-text">Bin Location</span></label>
                <input type="text" id="edit_bin" class="input input-bordered w-full" />
            </div>
        </div>

        <div class="form-control w-full mt-4">
            <label class="label"><span class="label-text">Status</span></label>
            <select id="edit_status" class="select select-bordered">
                <option value="in_cart">In Cart</option>
                <option value="need_to_list">Need to List</option>
                <option value="listed">Listed</option>
                <option value="sold">Sold</option>
            </select>
        </div>

        <div class="divider">Description</div>
        
        <!-- Description Tabs -->
        <div class="tabs tabs-boxed mb-2">
            <a class="tab tab-active" id="tab_edit_desc">Edit</a> 
            <a class="tab" id="tab_preview_desc">Preview</a>
        </div>

        <!-- Edit Mode -->
        <div id="desc_edit_mode" class="form-control w-full">
            <textarea id="edit_description" class="textarea textarea-bordered h-48 font-mono text-xs" placeholder="Product description..."></textarea>
        </div>

        <!-- Preview Mode -->
        <div id="desc_preview_mode" class="hidden w-full h-48 overflow-y-auto border border-base-300 rounded-lg p-4 bg-base-100">
            <!-- Prose content will be injected here -->
            <article id="desc_preview_content" class="prose prose-sm prose-invert max-w-none">
            </article>
        </div>

        <div class="divider">Photos</div>
        
        <div class="form-control w-full mb-4">
            <label class="label"><span class="label-text text-xs">Main Photo</span></label>
            <div id="edit_main_img_container" class="w-24 h-24 rounded-lg overflow-hidden border border-base-300 bg-base-200 relative">
                <img id="edit_main_img" class="w-full h-full object-cover hidden" />
                <div id="edit_main_img_placeholder" class="absolute inset-0 flex items-center justify-center text-2xl opacity-50">üì¶</div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
             <div class="form-control w-full">
                <label class="label"><span class="label-text text-xs">Gallery Photos</span></label>
                
                <!-- Existing Gallery -->
                <div id="existing_gallery_container" class="mb-2 hidden">
                     <p class="text-[10px] uppercase opacity-50 mb-1">Current</p>
                     <div id="existing_gallery_previews" class="flex gap-2 overflow-x-auto pb-2"></div>
                </div>

                <!-- Custom File Picker -->
                <div class="grid grid-cols-2 gap-2">
                    <div id="gallery_upload_area" class="border-2 border-dashed border-base-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors bg-base-100 flex flex-col items-center justify-center gap-2">
                        <input type="file" id="edit_gallery_imgs" multiple accept="image/*" class="hidden" />
                        <span class="text-2xl">üìÅ</span>
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-primary">Upload</span>
                            <span class="text-[9px] opacity-60">Select Files</span>
                        </div>
                    </div>
                    <div id="gallery_camera_btn" class="border-2 border-dashed border-base-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors bg-base-100 flex flex-col items-center justify-center gap-2">
                        <span class="text-2xl">üì∏</span>
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-primary">Camera</span>
                            <span class="text-[9px] opacity-60">Take Photos</span>
                        </div>
                    </div>
                </div>
                <!-- Preview List -->
                <div id="gallery_previews" class="flex gap-2 mt-2 overflow-x-auto py-2 min-h-[4rem]"></div>
            </div>
             <div class="form-control w-full">
                <label class="label"><span class="label-text text-xs">Receipt Photo</span></label>
                <input type="file" id="edit_receipt_img" accept="image/*" class="file-input file-input-sm file-input-bordered w-full" />
            </div>
        </div>

        <div class="modal-action">
          <form method="dialog">
            <button class="btn btn-ghost">Cancel</button>
          </form>
          <button id="edit_save" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </dialog>

    <!-- CAMERA MODAL -->
    <dialog id="camera_modal" class="modal">
      <div class="modal-box p-0 bg-black w-full h-full max-h-full max-w-full rounded-none md:rounded-xl md:h-auto md:max-w-2xl">
        <div class="relative w-full h-full flex flex-col">
            <video id="edit_camera_video" autoplay playsinline class="w-full h-full object-cover flex-1"></video>
            
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent flex justify-center gap-8 items-center">
                 <button id="close_camera_btn" class="btn btn-circle btn-ghost text-white bg-white/20 backdrop-blur-md">
                    ‚úï
                </button>
                <button id="capture_camera_btn" class="btn btn-circle btn-primary btn-lg border-4 border-white transform active:scale-95 transition-transform w-20 h-20">
                    <span class="sr-only">Capture</span>
                </button>
                 <button id="flip_camera_btn" class="btn btn-circle btn-ghost text-white bg-white/20 backdrop-blur-md">
                    üîÑ
                </button>
                 <!-- Captured Count Indicator -->
                 <div id="camera_capture_count" class="absolute top-[-40px] right-6 badge badge-lg badge-success font-bold hidden">
                    +1
                 </div>
            </div>
        </div>
      </div>
    </dialog>

    <!-- CAMERA MODAL -->
    <dialog id="camera_modal" class="modal">
      <div class="modal-box p-0 bg-black w-full h-full max-h-full max-w-full rounded-none md:rounded-xl md:h-auto md:max-w-2xl">
        <div class="relative w-full h-full flex flex-col">
            <video id="edit_camera_video" autoplay playsinline class="w-full h-full object-cover flex-1"></video>
            
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent flex justify-center gap-8 items-center">
                 <button id="close_camera_btn" class="btn btn-circle btn-ghost text-white bg-white/20 backdrop-blur-md">
                    ‚úï
                </button>
                <button id="capture_camera_btn" class="btn btn-circle btn-primary btn-lg border-4 border-white transform active:scale-95 transition-transform w-20 h-20">
                    <span class="sr-only">Capture</span>
                </button>
                 <button id="flip_camera_btn" class="btn btn-circle btn-ghost text-white bg-white/20 backdrop-blur-md">
                    üîÑ
                </button>
                 <!-- Captured Count Indicator -->
                 <div id="camera_capture_count" class="absolute top-[-40px] right-6 badge badge-lg badge-success font-bold hidden">
                    +1
                 </div>
            </div>
        </div>
      </div>
    </dialog>
</div>

<script>
    import { deleteInventoryItem, updateInventoryItem } from '../lib/inventory';
    import { actions } from 'astro:actions';
    import { marked } from 'marked';

    console.log('[Debug] Marked library loaded:', marked);

    // CHECKOUT LOGIC
    const modal = document.getElementById('checkout_modal') as HTMLDialogElement;
    const editModal = document.getElementById('edit_modal') as HTMLDialogElement;
    let activeItemId = null;
    let receiptFile = null;
    let stream = null;

    document.querySelectorAll('.purchase-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget as HTMLElement;
            activeItemId = target.dataset.id;
            const title = target.dataset.title;
            
            document.getElementById('checkout_item_title').innerText = title || 'Item';
            
            // Reset View State
            document.getElementById('checkout_form_wrapper').classList.remove('hidden');
            document.getElementById('checkout_result_wrapper').classList.add('hidden');
            
            modal.showModal();
        });
    });

    // Camera Logic
    const video = document.getElementById('checkout_video') as HTMLVideoElement;
    const captureBtn = document.getElementById('checkout_capture_btn');
    const startCameraBtn = document.getElementById('checkout_camera_btn');
    const preview = document.getElementById('checkout_preview');
    const previewImg = document.getElementById('checkout_preview_img') as HTMLImageElement;

    startCameraBtn?.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            video.classList.remove('hidden');
            captureBtn?.classList.remove('hidden');
            startCameraBtn.classList.add('hidden');
        } catch (err) {
            alert('Cannot access camera');
        }
    });

    captureBtn?.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        canvas.toBlob(blob => {
            receiptFile = new File([blob], "receipt.jpg", { type: "image/jpeg" });
            previewImg.src = URL.createObjectURL(blob);
            preview.classList.remove('hidden');
            
            // Stop camera
            stream.getTracks().forEach(t => t.stop());
            video.classList.add('hidden');
            captureBtn.classList.add('hidden');
        }, 'image/jpeg', 0.8);
    });

    // Handle File Input
    document.getElementById('checkout_file')?.addEventListener('change', (e) => {
        const file = (e.target as HTMLInputElement).files[0];
        if(file) {
            receiptFile = file;
            previewImg.src = URL.createObjectURL(file);
            preview.classList.remove('hidden');
        }
    });

    // Confirm Purchase
    document.getElementById('checkout_confirm')?.addEventListener('click', async () => {
        if (!activeItemId) return;
        const confirmBtn = document.getElementById('checkout_confirm');
        confirmBtn.classList.add('loading');
        
        try {
            const price = (document.getElementById('checkout_price') as HTMLInputElement).value;
            
            console.log('[Checkout] Updating inventory item...', activeItemId);
            await updateInventoryItem(activeItemId, {
                status: 'need_to_list',
                paidPrice: price,
                receiptFile: receiptFile
            });
            console.log('[Checkout] Inventory updated. Swapping UI...');
            
            // UI Update: Swap Content
            const formWrapper = document.getElementById('checkout_form_wrapper');
            const resultWrapper = document.getElementById('checkout_result_wrapper');
            const descArea = document.getElementById('generated_description') as HTMLTextAreaElement;
            
            formWrapper.classList.add('hidden');
            resultWrapper.classList.remove('hidden');
            
            try {
                // Call Generation API
                const res = await fetch('/api/generate-description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId: activeItemId })
                });
                
                let data;
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await res.json();
                } else {
                    // unexpected response (e.g. 404 html, 500 html)
                    const text = await res.text();
                    throw new Error(`Server returned ${res.status}: ${text.slice(0, 100)}...`);
                }
                
                if (data.success && data.description) {
                    let text = data.description;
                    if (data.warning) {
                        text += `\n\n‚ö†Ô∏è SYSTEM WARNING: ${data.warning}`;
                    }
                    descArea.value = text;
                } else {
                    descArea.value = "Failed to generate description: " + (data.error || "Unknown error");
                }
            } catch (apiErr) {
                 descArea.value = "Error calling AI service: " + apiErr.message;
            }
            
            confirmBtn.classList.remove('loading');

            // Handle Final Close without auto reload immediately
            document.getElementById('checkout_close_final')?.addEventListener('click', () => {
                window.location.reload();
            });

        } catch (err) {
            console.error(err);
            alert('Purchase update failed');
            confirmBtn.classList.remove('loading');
        }
    });


    // Handle Deletion
    const deleteBtns = document.querySelectorAll('.delete-btn');
    deleteBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
            if(!confirm('Are you sure you want to delete this item?')) return;
            
            const target = e.target as HTMLElement;
            // Handle clicking icon inside button
            const btnEl = target.closest('.delete-btn') as HTMLElement;
            const id = btnEl?.dataset.id;
            
            if (id) {
                try {
                    btnEl.classList.add('loading');
                    await deleteInventoryItem(id);
                    // Refresh page to show updates (simplest for Astro SSR)
                    window.location.reload();
                } catch (err) {
                    alert('Failed to delete item');
                    console.error(err);
                    btnEl.classList.remove('loading');
                }
            }
        });
    });


    // Handle Edit
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget as HTMLElement;
            activeItemId = target.dataset.id;
            
            // Populate Fields
            (document.getElementById('edit_title') as HTMLInputElement).value = target.dataset.title || '';
            (document.getElementById('edit_price') as HTMLInputElement).value = target.dataset.price || '';
            (document.getElementById('edit_bin') as HTMLInputElement).value = target.dataset.bin || '';
            (document.getElementById('edit_status') as HTMLSelectElement).value = target.dataset.status || 'draft';
            (document.getElementById('edit_description') as HTMLTextAreaElement).value = target.dataset.description || '';
            
            // Reset Tabs
            document.getElementById('tab_edit_desc').classList.add('tab-active');
            document.getElementById('tab_preview_desc').classList.remove('tab-active');
            document.getElementById('desc_edit_mode').classList.remove('hidden');
            document.getElementById('desc_preview_mode').classList.add('hidden');
            
            // Handle Main Image
            const mainImg = document.getElementById('edit_main_img') as HTMLImageElement;
            const mainImgPlaceholder = document.getElementById('edit_main_img_placeholder');
            const mainImageId = target.dataset.image;

            if (mainImageId) {
                // Construct URL (using env vars defined below)
                // Note: We need to access env vars here. They are defined later in the script but are hoisted or we can just access import.meta.env directly or move the consts up. 
                // However, the consts APPWRITE_ENDPOINT etc are defined *after* this block in the original code. 
                // Let's use import.meta.env directly or rely on the consts being available if they are in the same scope (module scope).
                // Actually they are defined below in the script. I should probably move them up or just use import.meta.env here.
                // To be safe and clean, I will just use import.meta.env variables directly here or assume the consts are hoisted (var) or available (let/const are block scoped but this is inside an event listener). 
                // Wait, the consts APPWRITE_ENDPOINT are defined at top level of <script>. They are available in the event listener callback.
                
                mainImg.src = `${APPWRITE_ENDPOINT}/storage/buckets/${APPWRITE_BUCKET}/files/${mainImageId}/view?project=${APPWRITE_PROJECT}`;
                mainImg.classList.remove('hidden');
                mainImgPlaceholder?.classList.add('hidden');
            } else {
                mainImg.src = '';
                mainImg.classList.add('hidden');
                mainImgPlaceholder?.classList.remove('hidden');
            }

            // Reset files
            (document.getElementById('edit_gallery_imgs') as HTMLInputElement).value = '';
            (document.getElementById('edit_receipt_img') as HTMLInputElement).value = '';
            
            // Clear custom gallery state
            galleryBuffer = []; 
            renderGalleryPreviews();

            // Handle Existing Gallery
            try {
                const galleryIds = JSON.parse(target.dataset.gallery || '[]');
                currentGalleryList = galleryIds;
                renderExistingGallery();
            } catch (e) {
                currentGalleryList = [];
            }
            
            editModal.showModal();
        });
    });

    // Custom Gallery Logic
    let galleryBuffer: File[] = [];
    let currentGalleryList: string[] = []; // IDs of existing photos
    
    // Env vars for constructing URLs in client script
    const APPWRITE_ENDPOINT = import.meta.env.PUBLIC_APPWRITE_ENDPOINT;
    const APPWRITE_PROJECT = import.meta.env.PUBLIC_APPWRITE_PROJECT_ID;
    const APPWRITE_BUCKET = import.meta.env.PUBLIC_APPWRITE_BUCKET_ID;

    const galleryInput = document.getElementById('edit_gallery_imgs') as HTMLInputElement;
    const galleryArea = document.getElementById('gallery_upload_area');
    const galleryPreviews = document.getElementById('gallery_previews');
    const existingGalleryContainer = document.getElementById('existing_gallery_container');
    const existingGalleryPreviews = document.getElementById('existing_gallery_previews');

    galleryArea?.addEventListener('click', () => galleryInput.click());

    galleryInput?.addEventListener('change', (e) => {
        const files = (e.target as HTMLInputElement).files;
        if (files) {
            // Append new files to buffer
            galleryBuffer = [...galleryBuffer, ...Array.from(files)];
            renderGalleryPreviews();
        }
    });

    // --- CAMERA LOGIC FOR EDIT ---
    const cameraModal = document.getElementById('camera_modal') as HTMLDialogElement;
    const cameraBtn = document.getElementById('gallery_camera_btn');
    const closeCameraBtn = document.getElementById('close_camera_btn');
    const editCaptureBtn = document.getElementById('capture_camera_btn');
    const flipBtn = document.getElementById('flip_camera_btn');
    const videoEl = document.getElementById('edit_camera_video') as HTMLVideoElement;
    
    let cameraStream: MediaStream | null = null;
    let facingMode: 'user' | 'environment' = 'environment';

    cameraBtn?.addEventListener('click', () => {
        openCamera();
    });

    closeCameraBtn?.addEventListener('click', () => {
        stopCamera();
        cameraModal.close();
    });

    flipBtn?.addEventListener('click', () => {
        facingMode = facingMode === 'environment' ? 'user' : 'environment';
        stopCamera();
        openCamera();
    });

    editCaptureBtn?.addEventListener('click', () => {
        if (!videoEl.srcObject) return;
        
        const canvas = document.createElement('canvas');
        // Max dimensions
        const MAX_WIDTH = 1000;
        let w = videoEl.videoWidth;
        let h = videoEl.videoHeight;
        
        if (w > MAX_WIDTH) {
            h *= MAX_WIDTH / w;
            w = MAX_WIDTH;
        }
        
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoEl, 0, 0, w, h);
        
        // Flash effect
        videoEl.classList.add('opacity-50');
        setTimeout(() => videoEl.classList.remove('opacity-50'), 100);

        canvas.toBlob(blob => {
            const file = new File([blob], `cam_${Date.now()}.jpg`, { type: 'image/jpeg' });
            galleryBuffer.push(file);
            renderGalleryPreviews();
            
            // Show feedback
            const indicator = document.getElementById('camera_capture_count');
            indicator.classList.remove('hidden');
            indicator.innerText = `+${galleryBuffer.length}`;
            setTimeout(() => indicator.classList.add('hidden'), 1000);
            
        }, 'image/jpeg', 0.8);
    });

    async function openCamera() {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: facingMode }
            });
            videoEl.srcObject = cameraStream;
            cameraModal.showModal();
        } catch (err) {
            console.error(err);
            alert('Could not access camera');
        }
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(t => t.stop());
            cameraStream = null;
        }
    }

    function renderExistingGallery() {
        if (!existingGalleryPreviews) return;
        existingGalleryPreviews.innerHTML = '';
        
        if (currentGalleryList.length === 0) {
            existingGalleryContainer.classList.add('hidden');
            return;
        }
        existingGalleryContainer.classList.remove('hidden');

        currentGalleryList.forEach((id) => {
             const div = document.createElement('div');
            div.className = 'relative w-16 h-16 shrink-0 group';
            
            const img = document.createElement('img');
            img.src = `${APPWRITE_ENDPOINT}/storage/buckets/${APPWRITE_BUCKET}/files/${id}/view?project=${APPWRITE_PROJECT}`;
            img.className = 'w-full h-full object-cover rounded border border-base-300';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-xs btn-circle btn-error absolute -top-1 -right-1 w-4 h-4 min-h-0 text-[10px] items-center justify-center flex';
            removeBtn.innerHTML = '‚úï';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                // Remove from list
                currentGalleryList = currentGalleryList.filter(item => item !== id);
                renderExistingGallery();
            };

            div.appendChild(img);
            div.appendChild(removeBtn);
            existingGalleryPreviews.appendChild(div);
        });
    }

    function renderGalleryPreviews() {
        if (!galleryPreviews) return;
        galleryPreviews.innerHTML = '';
        galleryBuffer.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'relative w-16 h-16 shrink-0 group';
            
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'w-full h-full object-cover rounded border border-base-300';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-xs btn-circle btn-error absolute -top-1 -right-1 w-4 h-4 min-h-0 text-[10px] items-center justify-center flex';
            removeBtn.innerHTML = '‚úï';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                galleryBuffer.splice(index, 1);
                renderGalleryPreviews();
            };

            div.appendChild(img);
            div.appendChild(removeBtn);
            galleryPreviews.appendChild(div);
        });
    }

    // Save Edit
    document.getElementById('edit_save')?.addEventListener('click', async () => {
        if (!activeItemId) return;
        const saveBtn = document.getElementById('edit_save');
        saveBtn.classList.add('loading');
        
        try {
            // Use galleryBuffer instead of input.files
            const receiptImgFile = (document.getElementById('edit_receipt_img') as HTMLInputElement).files?.[0];

            await updateInventoryItem(activeItemId, {
                title: (document.getElementById('edit_title') as HTMLInputElement).value,
                paidPrice: (document.getElementById('edit_price') as HTMLInputElement).value,
                binLocation: (document.getElementById('edit_bin') as HTMLInputElement).value,
                status: (document.getElementById('edit_status') as HTMLSelectElement).value as any,
                galleryFiles: galleryBuffer,
                existingGalleryIds: currentGalleryList,
                receiptFile: receiptImgFile
            });
            window.location.reload();
        } catch (err) {
            console.error(err);
            alert('Update failed');
            saveBtn.classList.remove('loading');
        }
    });
    // Description Tabs Logic
    const tabEdit = document.getElementById('tab_edit_desc');
    const tabPreview = document.getElementById('tab_preview_desc');
    const modeEdit = document.getElementById('desc_edit_mode');
    const modePreview = document.getElementById('desc_preview_mode');
    const previewContent = document.getElementById('desc_preview_content');
    const textarea = document.getElementById('edit_description') as HTMLTextAreaElement;

    tabEdit?.addEventListener('click', () => {
        tabEdit.classList.add('tab-active');
        tabPreview.classList.remove('tab-active');
        modeEdit.classList.remove('hidden');
        modePreview.classList.add('hidden');
    });

    // Helper to remove indentation that causes markdown to be treated as code blocks
    // Helper to remove indentation that causes markdown to be treated as code blocks
    function cleanAIResponse(str: string) {
        let cleaned = str;

        // 1. Robust Unwrap: Split by code fences
        // Matches ``` or ```markdown (case insensitive)
        const parts = cleaned.split(/```(?:markdown)?/i);
        
        if (parts.length >= 3) {
            // Case: Pre-text ``` Content ``` Post-text
            // returning parts[1] grabs the content inside the first block
            cleaned = parts[1];
        } else if (parts.length === 2) {
            // Case: ```markdown Content (missing closing?)
            cleaned = parts[1];
        }
        // If length is 1, no fences found, keep original or apply header heuristic
        else {
             const firstHeader = cleaned.indexOf('#');
             if (firstHeader > 0 && firstHeader < 100) {
                 cleaned = cleaned.substring(firstHeader);
             }
        }
        
        // 2. Strip common indentation
        const lines = cleaned.split('\n');
        let minIndent = Infinity;
        
        for (const line of lines) { // ... existing indent logic follows ...
            if (line.trim().length === 0) continue;
            const match = line.match(/^ */);
            if (match) {
                minIndent = Math.min(minIndent, match[0].length);
            }
        }
        
        if (minIndent !== Infinity && minIndent > 0) {
            cleaned = lines.map(line => {
                if (line.trim().length === 0) return '';
                return line.substring(minIndent);
            }).join('\n');
        }

        return cleaned.trim();
    }

    tabPreview?.addEventListener('click', () => {
        tabPreview.classList.add('tab-active');
        tabEdit.classList.remove('tab-active');
        modeEdit.classList.add('hidden');
        modePreview.classList.remove('hidden');
        
        // Render Markdown
        // Clean the response to handle Gemini's "Here is the markdown" wrappers
        const raw = cleanAIResponse(textarea.value);
        
        console.log('[Preview] Raw (Cleaned):', raw);
        if (raw) {
            try {
                const parsed = marked.parse(raw);
                previewContent.innerHTML = parsed;
            } catch (e) {
                console.error('Markdown parse error:', e);
                previewContent.innerHTML = '<p class="text-error">Error rendering preview</p>';
            }
        } else {
            previewContent.innerHTML = '<p class="text-xs opacity-50 italic">No description to preview.</p>';
        }
    });

</script>
