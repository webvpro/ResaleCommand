---
---

<div x-data="cameraAnalysis()" class="w-full max-w-2xl mx-auto p-6 bg-base-200 rounded-xl shadow-lg">
    <h2 class="text-2xl font-bold mb-4 text-center">Resale Scout</h2>

    <!-- Image Input Area -->
    <div class="form-control w-full mb-6 text-center">
        <label class="label">
            <span class="label-text">Capture or Upload Item</span>
        </label>
        
        <div class="flex gap-2 mb-4" x-show="!imageUrl && !isCameraOpen">
            <button @click="startCamera" class="btn btn-outline btn-primary flex-1 gap-2">
                ðŸ“· Start Camera
            </button>
            <div class="divider divider-horizontal">OR</div>
             <input 
                type="file" 
                x-ref="fileInput"
                @change="handleFileUpload" 
                accept="image/*" 
                class="file-input file-input-bordered file-input-primary w-full max-w-xs" 
            />
        </div>

        <!-- Live Camera View -->
        <div x-show="isCameraOpen" class="relative bg-black rounded-lg overflow-hidden">
            <video x-ref="videoPreview" autoplay playsinline class="w-full h-64 object-cover"></video>
            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4">
                <button @click="capturePhoto" class="btn btn-circle btn-primary btn-lg border-4 border-white">
                    <span class="sr-only">Capture</span>
                </button>
                <button @click="stopCamera" class="btn btn-circle btn-ghost text-white">
                    âœ•
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Area -->
    <div x-show="imageUrl" style="display: none;" class="mb-6 relative group">
        <img :src="imageUrl" alt="Preview" class="w-full h-64 object-contain bg-base-300 rounded-lg border-2 border-base-content/10">
        <button 
            @click="clearImage"
            class="btn btn-circle btn-sm btn-error absolute top-2 right-2 opacity-90 hover:opacity-100">
            âœ•
        </button>
    </div>

    <!-- Actions -->
    <div class="flex justify-center mb-6" x-show="imageUrl && !loading" style="display: none;">
        <button 
            @click="analyzeImage" 
            class="btn btn-primary btn-wide gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
            Analyze with Gemini
        </button>
    </div>

    <!-- Loading State -->
    <div x-show="loading" style="display: none;" class="flex flex-col items-center justify-center p-8 space-y-4">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="animate-pulse font-medium">Identifying item & estimating value...</p>
    </div>

    <!-- Results Area -->
    <div x-show="result" style="display: none;" class="bg-base-100 p-6 rounded-lg border border-base-300 space-y-4 animate-fade-in">
        
        <div class="flex justify-between items-start">
            <h3 class="text-xl font-bold text-primary" x-text="typeof result?.identity === 'object' ? Object.values(result.identity).join(' ') : (result?.identity || 'Accessory')"></h3>
        </div>

        <!-- Price Breakdown Table -->
        <div class="grid grid-cols-3 gap-2 mt-2">
            <div class="flex flex-col items-center p-2 bg-base-200 rounded-lg">
                <span class="text-xs uppercase font-bold opacity-60">New/Mint</span>
                <span class="text-lg font-bold text-success" x-text="result?.price_breakdown?.mint || '-'"></span>
            </div>
            <div class="flex flex-col items-center p-2 bg-base-200 rounded-lg border border-primary/20">
                <span class="text-xs uppercase font-bold opacity-60">Used/Fair</span>
                <span class="text-lg font-bold text-primary" x-text="result?.price_breakdown?.fair || '-'"></span>
            </div>
            <div class="flex flex-col items-center p-2 bg-base-200 rounded-lg">
                <span class="text-xs uppercase font-bold opacity-60">Poor</span>
                <span class="text-lg font-bold text-warning" x-text="result?.price_breakdown?.poor || '-'"></span>
            </div>
        </div>

        <div class="p-3 bg-base-200 rounded-md">
            <p class="text-sm font-mono opacity-75 mb-1">Suggested Title</p>
            <div class="flex gap-2">
                <input type="text" :value="result?.title" class="input input-sm input-ghost w-full font-bold focus:bg-base-100" readonly>
                <button class="btn btn-sm btn-ghost btn-square" @click="navigator.clipboard.writeText(result?.title)">
                   ðŸ“‹
                </button>
            </div>
        </div>

        <div class="divider">Using AI Insights</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h4 class="font-bold text-sm mb-2 opacity-70">Keywords</h4>
                <div class="flex flex-wrap gap-2">
                    <template x-for="keyword in (result?.keywords || [])">
                        <span class="badge badge-outline" x-text="keyword"></span>
                    </template>
                </div>
            </div>
            
            <div>
                <h4 class="font-bold text-sm mb-2 opacity-70">Condition Notes</h4>
                <p class="text-sm" x-text="result?.condition_notes || 'No issues detected.'"></p>
            </div>
        </div>

        <button @click="saveToInventory" class="btn btn-success w-full mt-4">
            Save to Inventory (Appwrite)
        </button>
    </div>
</div>

<script>
    import { saveItemToInventory } from '../lib/inventory';

    document.addEventListener('alpine:init', () => {
        Alpine.data('cameraAnalysis', () => ({
            imageUrl: null,
            imageFile: null,
            loading: false,
            result: null,
            isCameraOpen: false,
            stream: null,

            async handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                this.imageFile = file;
                this.result = null;
                
                // Resize image before setting imageUrl to avoid massive payload issues
                this.imageUrl = await this.resizeImageFromFile(file);
            },

            async resizeImageFromFile(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800; // Resize to max 800px width
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Return compressed JPEG base64 (0.7 quality)
                            // This reduces 5MB photos to ~100KB, preventing payload blocks
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                        };
                        img.src = readerEvent.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            },

            async startCamera() {
                try {
                    this.isCameraOpen = true;
                    // Prefer rear camera environment
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment" } 
                    });
                    this.$refs.videoPreview.srcObject = this.stream;
                } catch (err) {
                    console.error("Camera Error:", err);
                    alert("Could not access camera. Please allow permissions.");
                    this.isCameraOpen = false;
                }
            },

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                this.isCameraOpen = false;
            },

            capturePhoto() {
                if (!this.stream) return;
                
                const video = this.$refs.videoPreview;
                const canvas = document.createElement('canvas');
                
                // Resize logic for camera capture too
                const MAX_WIDTH = 800;
                let width = video.videoWidth;
                let height = video.videoHeight;
                
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }

                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, width, height);
                
                // Set image for analysis (compressed)
                this.imageUrl = canvas.toDataURL('image/jpeg', 0.7);
                
                // Keep imageFile in sync just in case
                canvas.toBlob(blob => {
                    this.imageFile = new File([blob], "capture.jpg", { type: "image/jpeg" });
                }, 'image/jpeg', 0.7);

                this.stopCamera();
            },

            clearImage() {
                this.imageUrl = null;
                this.imageFile = null;
                this.result = null;
                this.stopCamera(); // Ensure camera is off
                if(this.$refs.fileInput) this.$refs.fileInput.value = '';
            },

            async analyzeImage() {
                if (!this.imageUrl) {
                    alert("No image selected!");
                    return;
                }

                this.loading = true;
                const payload = this.imageUrl; // Store in local var to ensure non-reactive access
                console.log("Preparing to send. Payload length:", payload.length);

                try {
                    // WORKAROUND: Switching to PUT request to bypass 'installHook.js' interceptor
                    // which appears to be stripping POST bodies.
                    const response = await fetch(`/api/identify-item?len=${payload.length}`, {
                        method: 'PUT', 
                        headers: {
                            'Content-Type': 'application/octet-stream', // Changing content type to avoid parsing interception
                            'X-Client-Claim': 'Using PUT to bypass proxy'
                        },
                        body: payload
                    });

                    // Debugging response
                    console.log("Server responded with status:", response.status);

                    if (!response.ok) {
                        const errText = await response.text();
                        console.error("Server Error Headers:", [...response.headers.entries()]);
                        console.error("Server Error Body:", errText);
                        
                        let errData;
                        try {
                             errData = JSON.parse(errText);
                        } catch (e) {
                             errData = { error: errText };
                        }
                        console.error("Full Error Details:", errData);
                        alert(`Server Error: ${errData.details || errData.error}`);
                        throw new Error(errData.details || errData.error || 'Analysis failed');
                    }

                    this.result = await response.json();
                } catch (err) {
                    console.error("Camera Analysis Error:", err);
                    alert(`Error: ${err.message}`);
                } finally {
                    this.loading = false;
                }
            },

            async saveToInventory() {
                try {
                    const saveBtn = this.$el;
                    const originalText = saveBtn.innerText;
                    saveBtn.innerText = 'Saving...';
                    saveBtn.disabled = true;

                    await saveItemToInventory(this.result, this.imageFile);
                    
                    alert('Success! Item saved to Inventory.');
                    saveBtn.innerText = 'Saved!';
                } catch (err) {
                    console.error(err);
                    alert(`Save Failed: ${err.message}. \n\nCheck if you created the Database/Collection in Appwrite and added IDs to .env`);
                    this.$el.innerText = 'Save to Inventory (Appwrite)';
                    this.$el.disabled = false;
                }
            }
        }));
    });
</script>
