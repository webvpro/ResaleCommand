---
---

<div x-data="cameraAnalysis()" 
     class="w-full max-w-2xl mx-auto p-6 bg-base-200 rounded-xl shadow-lg transition-colors duration-200"
     :class="{ 'border-2 border-primary bg-base-300': isDragging }"
     @dragover.prevent="isDragging = true"
     @dragleave.prevent="isDragging = false"
     @drop.prevent="handleDrop">

    <h2 class="text-2xl font-bold mb-4 text-center">Resale Scout</h2>

    <!-- Drop Overlay Message -->
    <div x-show="isDragging" class="pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm rounded-xl">
        <p class="text-3xl font-bold text-white animate-bounce">Drop Image Here!</p>
    </div>

    <!-- Mode Switcher -->
    <div class="tabs tabs-boxed mb-6 justify-center bg-base-100 p-1">
        <a class="tab" :class="{ 'tab-active': mode === 'speed' }" @click="mode = 'speed'">‚ö° Speed Scout</a> 
        <a class="tab" :class="{ 'tab-active': mode === 'precision' }" @click="mode = 'precision'">üîç Precision</a>
    </div>

    <!-- Image Input Area -->
    <div class="form-control w-full mb-6 text-center">
        <label class="label">
            <span class="label-text">Capture or Upload Item(s)</span>
        </label>
        
        <!-- Input Controls -->
        <div class="flex gap-2 mb-4" x-show="!isCameraOpen">
            <button @click="startCamera" class="btn btn-outline btn-primary flex-1 gap-2" :disabled="images.length >= 5">
                üì∑ <span x-text="images.length > 0 ? 'Add Photo' : 'Start Camera'"></span>
            </button>
            <div class="divider divider-horizontal">OR</div>
             <input 
                type="file" 
                x-ref="fileInput"
                @change="handleFileUpload" 
                accept="image/*" 
                multiple
                class="file-input file-input-bordered file-input-primary w-full max-w-xs" 
                :disabled="images.length >= 5"
            />
        </div>

        <!-- Live Camera View -->
        <div x-show="isCameraOpen" class="relative bg-black rounded-lg overflow-hidden">
            <video x-ref="videoPreview" autoplay playsinline class="w-full h-64 object-cover"></video>
            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4 items-center">
                 <button @click="stopCamera" class="btn btn-circle btn-ghost text-white bg-black/40 backdrop-blur-sm">
                    Done
                </button>
                <button @click="capturePhoto" class="btn btn-circle btn-primary btn-lg border-4 border-white transform active:scale-95 transition-transform">
                    <span class="sr-only">Capture</span>
                </button>
                <button @click="switchCamera" class="btn btn-circle btn-ghost text-white bg-black/40 backdrop-blur-sm">
                    üîÑ
                </button>
                 <div class="w-12 text-white text-xs font-mono" x-text="`${images.length}/5`"></div>
            </div>
        </div>
    </div>

    <!-- Preview Area (Gallery) -->
    <div x-show="images.length > 0" class="mb-6">
        <div class="grid grid-cols-3 gap-2">
            <template x-for="(img, index) in images" :key="index">
                <div class="relative group aspect-square">
                    <img :src="img" alt="Preview" class="w-full h-full object-cover bg-base-300 rounded-lg border-2 border-base-content/10">
                    <button 
                        @click="removeImage(index)"
                        class="btn btn-circle btn-xs btn-error absolute top-1 right-1 opacity-90 hover:opacity-100 shadow-sm">
                        ‚úï
                    </button>
                </div>
            </template>
        </div>
         <div class="text-right mt-2">
            <button @click="clearAllImages" class="btn btn-xs btn-ghost text-error">Clear All</button>
        </div>
    </div>

    <!-- Additional Details Input -->
    <div class="form-control w-full mb-6">
        <label class="label">
            <span class="label-text">Additional Details (Optional)</span>
            <span class="label-text-alt">Size, Brand, Defects, etc.</span>
        </label>
        <textarea 
            x-model="userNotes" 
            class="textarea textarea-bordered h-24" 
            placeholder="e.g. Size Large, Nike tag from 2015, small tear on sleeve..."></textarea>
    </div>

    <!-- Actions -->
    <div class="flex justify-center mb-6" x-show="images.length > 0 && !loading">
        <button 
            @click="analyzeImage" 
            class="btn btn-primary btn-wide gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
            Analyze with Gemini
        </button>
    </div>

    <!-- Loading State -->
    <div x-show="loading" style="display: none;" class="flex flex-col items-center justify-center p-8 space-y-4">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="animate-pulse font-medium">Identifying item & estimating value...</p>
    </div>

    <!-- Results Area -->
    <div x-show="result" style="display: none;" class="space-y-6">
        
        <!-- Global Inputs for Batch -->
        <div class="bg-base-100 p-4 rounded-lg border border-base-300 shadow-sm">
            <h3 class="font-bold text-lg mb-2">Details for All Items</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Paid Price ($)</span>
                    </label>
                    <input type="number" step="0.01" x-model="paidPrice" placeholder="0.00" class="input input-bordered w-full" />
                </div>
                
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Purchase Location / URL</span>
                    </label>
                    <div class="flex gap-2">
                        <input type="text" x-model="purchaseLocation" placeholder="e.g. Goodwill, Garage Sale" class="input input-bordered w-full" />
                        <button @click="getLocation" class="btn btn-square btn-outline" title="Use Current Location" :class="{ 'loading': gettingLocation }">
                            <span x-show="!gettingLocation">üìç</span>
                        </button>
                    </div>
                </div>

                <!-- NEW: Bin Location (Physical Cart/Bin) -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Cart / Bin Location</span>
                    </label>
                     <input type="text" x-model="binLocation" placeholder="e.g. Front Cart, Blue Bin" class="input input-bordered w-full" />
                </div>
                
                <div class="form-control w-full col-span-1 md:col-span-2">
                    <label class="label">
                        <span class="label-text">Receipt Photo (Optional)</span>
                    </label>
                    <input type="file" @change="receiptFile = $event.target.files[0]" accept="image/*" class="file-input file-input-bordered w-full" />
                </div>
            </div>
        </div>

        <!-- NEW: Logic for Speed vs Precision -->
        <div x-show="mode === 'precision'">
             <!-- Only show Calculator in Precision Mode or if requested -->
             <div class="divider">Calculators</div>
             <p class="text-sm opacity-60 text-center mb-4">Adjust values to calculate your Max Buy Price.</p>
        </div>

        <!-- Items List -->
        <template x-for="(item, index) in (result?.items || [])" :key="index">
            <div class="bg-base-100 p-6 rounded-lg border-2 border-base-300 shadow-lg space-y-4 animate-fade-in relative hover:border-primary transition-colors">
                
                <div class="absolute top-4 right-4 badge badge-lg badge-neutral" x-text="`#${index + 1}`"></div>

                <div class="flex justify-between items-start pr-12">
                    <h3 class="text-xl font-bold text-primary" x-text="typeof item?.identity === 'object' ? Object.values(item.identity).join(' ') : (item?.identity || 'Unidentified Item')"></h3>
                </div>

                <!-- Price Breakdown Table -->
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <div class="flex flex-col items-center p-2 bg-base-200 rounded-lg">
                        <span class="text-xs uppercase font-bold opacity-60">New/Mint</span>
                        <span class="text-lg font-bold text-success" x-text="item?.price_breakdown?.mint || '-'"></span>
                    </div>
                    <div class="flex flex-col items-center p-2 bg-base-200 rounded-lg border border-primary/20 cursor-pointer hover:bg-base-300"
                         @click="selectedPrice = parsePrice(item?.price_breakdown?.fair)">
                        <span class="text-xs uppercase font-bold opacity-60">Used/Fair</span>
                        <span class="text-lg font-bold text-primary" x-text="item?.price_breakdown?.fair || '-'"></span>
                    </div>
                    <div class="flex flex-col items-center p-2 bg-base-200 rounded-lg">
                        <span class="text-xs uppercase font-bold opacity-60">Poor</span>
                        <span class="text-lg font-bold text-warning" x-text="item?.price_breakdown?.poor || '-'"></span>
                    </div>
                </div>

                <!-- Calculator Injection -->
                <div x-data="{ localSalePrice: 0 }" x-effect="localSalePrice = parsePrice(item?.price_breakdown?.fair)" class="mt-4">
                    <div x-show="mode === 'precision'">
                        <div x-data="profitCalculator(localSalePrice)" 
                             @max-buy-update="item.maxBuyPrice = $event.detail.value"
                             class="bg-base-100 p-4 rounded-lg shadow-sm border border-base-200">
                             
                            <h4 class="font-bold text-sm mb-2 opacity-70">üí∞ Max Buy Calculator</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="form-control hover:bg-base-200 rounded p-1 transition-colors">
                                    <label class="label p-0 mb-1 pointer-events-none">
                                        <span class="label-text text-[10px] font-bold uppercase opacity-60">Est. Sale</span>
                                    </label>
                                    <input type="number" x-model.number="salePrice" class="input input-sm input-ghost w-full font-bold text-right p-0 h-6" @input="calculate" />
                                </div>
                                <div class="form-control hover:bg-base-200 rounded p-1 transition-colors">
                                    <label class="label p-0 mb-1 pointer-events-none">
                                        <span class="label-text text-[10px] font-bold uppercase opacity-60">Shipping</span>
                                    </label>
                                    <input type="number" x-model.number="shipping" class="input input-sm input-ghost w-full text-right p-0 h-6" @input="calculate" />
                                </div>
                                <div class="form-control hover:bg-base-200 rounded p-1 transition-colors">
                                    <label class="label p-0 mb-1 pointer-events-none">
                                        <span class="label-text text-[10px] font-bold uppercase opacity-60">Fee %</span>
                                    </label>
                                    <div class="flex items-center justify-end">
                                        <input type="number" x-model.number="feePercent" class="input input-sm input-ghost w-12 text-right p-0 h-6" @input="calculate" />
                                        <span class="text-xs opacity-50 ml-1">%</span>
                                    </div>
                                </div>
                                <div class="form-control hover:bg-base-200 rounded p-1 transition-colors">
                                    <label class="label p-0 mb-1 pointer-events-none">
                                        <span class="label-text text-[10px] font-bold uppercase opacity-60 text-success">Target Profit</span>
                                    </label>
                                    <input type="number" x-model.number="targetProfit" class="input input-sm input-ghost w-full text-success font-bold text-right p-0 h-6" @input="calculate" />
                                </div>
                            </div>
                            
                            <div class="mt-3 pt-3 border-t border-base-200 flex justify-between items-end">
                                <span class="text-xs font-bold uppercase opacity-50">Max Buy</span>
                                <span class="text-2xl font-black tracking-tighter" :class="maxBuyPrice > 0 ? 'text-success' : 'text-error'" x-text="`$${maxBuyPrice.toFixed(2)}`"></span>
                            </div>
                        </div>
                    </div>
                    <!-- Speed Mode Summary -->
                    <div x-show="mode === 'speed'" class="flex flex-col gap-2 bg-neutral text-neutral-content p-3 rounded-lg mt-2">
                        <div class="flex justify-between items-center">
                             <span class="font-bold text-sm">Quick Max Buy (Est)</span>
                             <span class="text-xl font-bold text-success" x-text="`~$${(Math.max(0, localSalePrice * 0.5 - 10)).toFixed(0)}`"></span>
                        </div>
                        
                        <!-- Red Flags Warning -->
                        <template x-if="item.red_flags && item.red_flags.length > 0">
                            <div class="alert alert-error text-white shadow-lg text-xs p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-4 w-4" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <div class="flex flex-col">
                                    <span class="font-bold uppercase">Condition Red Flags!</span>
                                    <div class="flex gap-1 flex-wrap">
                                        <template x-for="flag in item.red_flags">
                                            <span class="badge badge-xs badge-white text-error" x-text="flag"></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Market Comparables -->
                <div class="collapse collapse-arrow bg-base-200 rounded-lg" x-show="item?.comparables && item.comparables.length > 0">
                    <input type="checkbox" /> 
                    <div class="collapse-title font-medium text-sm">
                        View Market Comparables
                    </div>
                    <div class="collapse-content text-sm">
                        <div class="overflow-x-auto">
                            <table class="table table-xs">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Est. Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="comp in (item?.comparables || [])">
                                    <tr>
                                        <td x-text="comp.name" class="whitespace-normal"></td>
                                        <td class="font-bold whitespace-nowrap" x-text="comp.price"></td>
                                    </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-base-200 rounded-md">
                    <p class="text-sm font-mono opacity-75 mb-1">Suggested Title</p>
                    <div class="flex gap-2">
                        <input type="text" :value="item?.title" class="input input-sm input-ghost w-full font-bold focus:bg-base-100" readonly>
                        <button class="btn btn-sm btn-ghost btn-square" @click="navigator.clipboard.writeText(item?.title)">
                        üìã
                        </button>
                    </div>
                </div>

                <div class="divider text-xs opacity-50">Details</div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-bold text-xs mb-2 opacity-70">Keywords</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="keyword in (item?.keywords || [])">
                                <span class="badge badge-sm badge-outline" x-text="keyword"></span>
                            </template>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-xs mb-2 opacity-70">Condition Notes</h4>
                        <p class="text-xs" x-text="item?.condition_notes || 'No specific issues detected by AI.'"></p>
                    </div>
                </div>
                
                <button @click="saveToInventory(item, $el)" class="btn btn-success w-full mt-4 text-white">
                    <span x-show="mode === 'speed'">‚ö° Save to Cart</span>
                    <span x-show="mode === 'precision'">Save to 'Need to List'</span>
                </button>
            </div>
        </template>
    </div>
</div>

<script>
    import { saveItemToInventory } from '../lib/inventory';

    // Helper to parse price strings like "$15.00", "$150", or Range "$40-70"
    // Made global so Alpine x-effect can access it
    window.parsePrice = function(priceStr) {
        if (!priceStr) return 0;
        
        // Match standard numbers (including decimals)
        const matches = priceStr.match(/[0-9.]+/g);
        if (!matches || matches.length === 0) return 0;
        
        // If range (e.g. 40-70), take average
        if (matches.length >= 2) {
             const v1 = parseFloat(matches[0]);
             const v2 = parseFloat(matches[1]);
             return (v1 + v2) / 2;
        }
        
        // Single value
        return parseFloat(matches[0]) || 0;
    }

    document.addEventListener('alpine:init', () => {
        
        Alpine.data('profitCalculator', (initialPrice) => ({
            salePrice: initialPrice || 0,
            shipping: 10,
            feePercent: 13,
            targetProfit: 15,
            maxBuyPrice: 0,
            init() { 
                this.calculate(); 
                this.$watch('salePrice', () => this.calculate());
            },
            calculate() {
                const fees = this.salePrice * (this.feePercent / 100);
                const costs = fees + this.shipping + this.targetProfit;
                const max = this.salePrice - costs;
                this.maxBuyPrice = max > 0 ? max : 0;
                this.$dispatch('max-buy-update', { value: this.maxBuyPrice });
            }
        }));

        Alpine.data('cameraAnalysis', () => ({
            mode: 'speed', // Default mode
            images: [],
            imageFiles: [],
            userNotes: '',
            paidPrice: '',
            purchaseLocation: '',
            binLocation: '', // New field
            receiptFile: null, // New field
            gettingLocation: false,
            loading: false,
            result: null,
            isDragging: false,
            isCameraOpen: false,
            stream: null,
            currentFacingMode: 'environment',

            switchCamera() {
                this.currentFacingMode = this.currentFacingMode === 'environment' ? 'user' : 'environment';
                this.stopCamera();
                this.startCamera();
            },

            getLocation() {
                if (!navigator.geolocation) {
                    alert("Geolocation is not supported by your browser");
                    return;
                }
                
                this.gettingLocation = true;
                
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    try {
                        // Use OpenStreetMap Nominatim for Reverse Geocoding
                        // Note: Usage Policy requires identification, but for small personal apps standard UA is often tolerated.
                        // To be safer, we request jsonv2.
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        
                        if (data && data.address) {
                            // Construct a readable store/location name
                            const addr = data.address;
                            const parts = [];
                            
                            // Try to find a specific venue name
                            if (addr.shop) parts.push(addr.shop);
                            else if (addr.amenity) parts.push(addr.amenity);
                            else if (addr.tourism) parts.push(addr.tourism);
                            else if (addr.leisure) parts.push(addr.leisure);
                            else if (addr.office) parts.push(addr.office);
                            
                            // Add street/city
                            if (addr.road) parts.push(addr.road);
                            if (addr.city || addr.town || addr.village || addr.suburb) {
                                parts.push(addr.city || addr.town || addr.village || addr.suburb);
                            }

                            if (parts.length > 0) {
                                this.purchaseLocation = parts.join(', ');
                            } else {
                                this.purchaseLocation = data.display_name || `${latitude}, ${longitude}`;
                            }
                        } else {
                             this.purchaseLocation = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                        }
                    } catch (e) {
                        console.error("Geocoding error:", e);
                        // Fallback to coords
                        this.purchaseLocation = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                    } finally {
                        this.gettingLocation = false;
                    }
                }, (err) => {
                    console.error(err);
                    alert("Unable to retrieve location. Check browser permissions.");
                    this.gettingLocation = false;
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            },

            async handleFileUpload(e) {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                await this.processFiles(files);
                
                this.result = null;
                // Leave input value so change event triggers again if needed, 
                // but clearing it might be better UX if they want to re-select same file.
                // However, 'multiple' usually handles this.
                if(this.$refs.fileInput) this.$refs.fileInput.value = '';
            },

            async handleDrop(e) {
                this.isDragging = false;
                
                // 1. Handle Files (e.g. from desktop)
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    await this.processFiles(files);
                    return;
                }

                // 2. Handle URLs (e.g. from other browser tabs)
                const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
                if (url) {
                   console.log("Dropped URL:", url);
                   this.purchaseLocation = url;
                   
                   // Try to see if it's an image we can use
                   if (url.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i)) {
                       try {
                           // Attempt to fetch via proxy or directly (CORS often blocks this)
                           // For now, simple direct fetch attempt:
                           const response = await fetch(url);
                           if(response.ok) {
                               const blob = await response.blob();
                               const file = new File([blob], "dragged_image.jpg", { type: blob.type });
                               await this.processFiles([file]);
                           } else {
                               alert("Captured URL, but could not download image due to site security. Please save image and upload, or take a screenshot.");
                           }
                       } catch (err) {
                           console.warn("Could not fetch dropped image URL:", err);
                           alert("Captured URL for records, but could not process image directly (CORS locked).");
                       }
                   }
                }
            },

            async processFiles(files) {
                 for (let i = 0; i < files.length; i++) {
                     if (this.images.length >= 5) {
                        alert("Maximum 5 images allowed.");
                        break;
                     }
                     const file = files[i];
                     // Only process images
                     if (!file.type.startsWith('image/')) continue;

                     const resizedDataUrl = await this.resizeImageFromFile(file);
                     this.images.push(resizedDataUrl);
                     this.imageFiles.push(file);
                }
            },

            async resizeImageFromFile(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800; // Resize to max 800px width
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Return compressed JPEG base64 (0.7 quality)
                            // This reduces 5MB photos to ~100KB, preventing payload blocks
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                        };
                        img.src = readerEvent.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            },

            async startCamera() {
                try {
                    this.isCameraOpen = true;
                    // Prefer rear camera environment
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: this.currentFacingMode } 
                    });
                    this.$refs.videoPreview.srcObject = this.stream;
                } catch (err) {
                    console.error("Camera Error:", err);
                    alert("Could not access camera. Please allow permissions.");
                    this.isCameraOpen = false;
                }
            },

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                this.isCameraOpen = false;
            },

            capturePhoto() {
                if (!this.stream) return;
                
                 if (this.images.length >= 5) {
                    alert("Maximum 5 images allowed.");
                    return;
                }

                const video = this.$refs.videoPreview;
                const canvas = document.createElement('canvas');
                
                // Resize logic for camera capture too
                const MAX_WIDTH = 800;
                let width = video.videoWidth;
                let height = video.videoHeight;
                
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }

                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, width, height);
                
                // Set image for analysis (compressed)
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                this.images.push(dataUrl);
                
                // Keep imageFile in sync just in case
                canvas.toBlob(blob => {
                    const file = new File([blob], `capture_${Date.now()}.jpg`, { type: "image/jpeg" });
                    this.imageFiles.push(file);
                }, 'image/jpeg', 0.7);
            },

            removeImage(index) {
                this.images.splice(index, 1);
                this.imageFiles.splice(index, 1);
                this.result = null;
            },

            clearAllImages() {
                this.images = [];
                this.imageFiles = [];
                this.result = null;
                this.stopCamera(); // Ensure camera is off
                if(this.$refs.fileInput) this.$refs.fileInput.value = '';
            },

            async analyzeImage() {
                if (this.images.length === 0) {
                    alert("No images selected!");
                    return;
                }

                this.loading = true;
                // Use JSON payload with array of images AND user notes
                const payload = JSON.stringify({ 
                    images: this.images,
                    notes: this.userNotes 
                });
                console.log("Preparing to send. Payload length:", payload.length);

                try {
                    // WORKAROUND: Switching to PUT request to bypass 'installHook.js' interceptor
                    // which appears to be stripping POST bodies.
                    const response = await fetch(`/api/identify-item`, {
                        method: 'PUT', 
                        headers: {
                            'Content-Type': 'application/json', // JSON type
                            'X-Client-Claim': 'Using PUT to bypass proxy'
                        },
                        body: payload
                    });

                    // Debugging response
                    console.log("Server responded with status:", response.status);

                    if (!response.ok) {
                        const errText = await response.text();
                        console.error("Server Error Headers:", [...response.headers.entries()]);
                        console.error("Server Error Body:", errText);
                        
                        let errData;
                        try {
                             errData = JSON.parse(errText);
                        } catch (e) {
                             errData = { error: errText };
                        }
                        console.error("Full Error Details:", errData);
                        alert(`Server Error: ${errData.details || errData.error}`);
                        throw new Error(errData.details || errData.error || 'Analysis failed');
                    }

                    this.result = await response.json();

                    // Fallback backward compatibility if API returns old structure
                    if (this.result && !this.result.items && (this.result.identity || this.result.title)) {
                        this.result = { items: [{ ...this.result }] };
                    }
                } catch (err) {
                    console.error("Camera Analysis Error:", err);
                    alert(`Error: ${err.message}`);
                } finally {
                    this.loading = false;
                }
            },

            async saveToInventory(itemData, btnEl) {
                try {
                    // Handle button state if passed (from loop) or fallback to $el (from main button if used)
                    const saveBtn = btnEl || this.$el;
                    const originalText = saveBtn.innerText;
                    saveBtn.innerText = 'Saving...';
                    saveBtn.disabled = true;

                    // Providing the first image file for now, and extra data
                    // First image is main, rest are gallery
                    const mainImage = this.imageFiles[0];
                    const galleryImages = this.imageFiles.slice(1);

                    await saveItemToInventory(
                        itemData || this.result, 
                        mainImage, 
                        {
                            paidPrice: this.paidPrice,
                            purchaseLocation: this.purchaseLocation,
                            maxBuyPrice: itemData.maxBuyPrice?.toString() || "0",
                            binLocation: this.binLocation,
                            receiptFile: this.receiptFile,
                            status: this.mode === 'speed' ? 'in_cart' : 'need_to_list',
                            galleryFiles: galleryImages
                        }
                    );
                    
                    alert('Success! Item saved to Inventory.');
                    saveBtn.innerText = 'Saved!';
                    
                    // Visual feedback for list items
                    saveBtn.classList.remove('btn-success');
                    saveBtn.classList.add('btn-disabled');
                } catch (err) {
                    console.error(err);
                    alert(`Save Failed: ${err.message}. \n\nCheck if you created the Database/Collection in Appwrite and added IDs to .env`);
                    const saveBtn = btnEl || this.$el;
                    saveBtn.innerText = 'Save to Inventory';
                    saveBtn.disabled = false;
                }
            }
        }));
    });
</script>
