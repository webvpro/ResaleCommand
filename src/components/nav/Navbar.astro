---
import { Icon } from 'astro-icon/components'
import { nav } from "site-config";

---

<nav x-data="{ open: false }" class="navbar max-w-screen-lx mx-auto">
  <div class="navbar-start md:pl-2 lg:pl-8">
    {
      /* Logo */
    }
  </div>
  <div class="navbar-center"></div>
  <div class="navbar-end md:pr-2 lg:pr-8">
    {
      nav.map((nav, index) => (
        <a class="hidden md:inline-flex btn btn-lg btn-ghost hover:bg-base-200" href={nav.url}>
          {nav.text}
        </a>
      ))
    }
    
    <div class="hidden md:inline-flex items-center gap-2">
      <!-- Loading State -->
      <template x-if="$store.auth.loading">
        <button class="btn btn-ghost">
           <span class="loading loading-spinner loading-sm"></span>
        </button>
      </template>

      <!-- Content State -->
      <template x-if="!$store.auth.loading">
        <div class="flex items-center gap-2">
           <template x-if="!$store.auth.isAuthenticated">
             <a href="/login" class="btn btn-ghost">Login</a>
           </template>
           
           <template x-if="$store.auth.isAuthenticated">
                <div class="flex items-center gap-2">
                 <!-- Team Selector -->
                 <div class="dropdown dropdown-end mr-2">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-sm gap-2">
                       <span x-text="$store.auth.currentTeam ? $store.auth.currentTeam.name : 'Personal Inventory'"></span>
                       <Icon name="mdi:chevron-down" class="w-4 h-4" />
                    </div>
                    <ul tabindex="0" class="dropdown-content z-[50] menu p-2 shadow bg-base-100 rounded-box w-52">
                       <li><a @click="$store.auth.switchTeam(null)" :class="!$store.auth.currentTeam && 'active'">Personal Inventory</a></li>
                       <template x-for="team in $store.auth.teams" :key="team.$id">
                          <li><a @click="$store.auth.switchTeam(team)" x-text="team.name" :class="$store.auth.currentTeam && $store.auth.currentTeam.$id === team.$id && 'active'"></a></li>
                       </template>
                       <div class="divider my-0"></div>
                       <template x-if="!$store.auth.ownedTeam">
                           <li><a onclick="create_team_modal.showModal()">+ Create Organization</a></li>
                       </template>
                       <template x-if="$store.auth.currentTeam && $store.auth.ownedTeam && $store.auth.currentTeam.$id === $store.auth.ownedTeam.$id">
                           <li><a onclick="invite_member_modal.showModal()">+ Invite Member</a></li>
                       </template>
                    </ul>
                 </div>
    
                 <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost avatar placeholder cursor-pointer">
                      <div class="bg-neutral text-neutral-content rounded-full w-10">
                        <span class="text-xs" x-text="$store.auth.user.name.charAt(0).toUpperCase()"></span>
                      </div>
                    </div>
                    <ul tabindex="0" class="mt-3 z-50 p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                      <template x-if="$store.auth.isPartner">
                        <li><div class="badge badge-secondary w-full">Partner</div></li>
                      </template>
                      <li><a @click="$store.auth.logout()">Logout</a></li>
                    </ul>
                  </div>
                </div>
           </template>
        </div>
      </template>
    </div>

    <button @click="open = !open" class="btn btn-square btn-ghost md:hidden" aria-label="Menü öffnen">
      <Icon name="nav" />
    </button>

    <!-- Mobile Menu Fullscreen -->
    <div
      id="mobile-menu"
      x-show="open"
      x-transition:enter="transition ease-out duration-100"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-100"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-primary flex flex-col items-center justify-center space-y-6 z-50">
      <!-- Close Button -->
      <button @click="open = false" class="absolute top-6 right-6 text-4xl focus:outline-none" aria-label="Menü schließen"> &times; </button>
      {
        nav.map((nav, index) => (
          <a href={nav.url} class="text-2xl text-primary-content hover:text-accent" @click="open = false">
            {nav.text}
          </a>
        ))
      }
       <template x-if="!$store.auth.loading">
          <div class="flex flex-col items-center gap-4">
             <template x-if="!$store.auth.isAuthenticated">
                <a href="/login" class="text-2xl text-primary-content hover:text-accent" @click="open = false">Login</a>
             </template>
              <template x-if="$store.auth.isAuthenticated">
                 <div class="flex flex-col items-center gap-2">
                    <span x-text="'Hello, ' + $store.auth.user.name" class="text-lg font-bold text-primary-content"></span>
                    <template x-if="$store.auth.isPartner">
                       <span class="badge badge-secondary">Partner</span>
                    </template>
                    <a @click="$store.auth.logout(); open = false" class="text-2xl text-primary-content hover:text-accent cursor-pointer">Logout</a>
                 </div>
              </template>
          </div>
       </template>
    </div>
  </div>
</nav>

<dialog id="create_team_modal" class="modal" x-data="{ teamName: '' }">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Create New Organization</h3>
    <p class="py-2 text-sm">Create a shared workspace for your inventory.</p>
    <div class="py-4">
        <input type="text" placeholder="Organization Name" class="input input-bordered w-full" x-model="teamName" @keydown.enter.prevent="$store.auth.createTeam(teamName); teamName = ''; create_team_modal.close()" />
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Cancel</button>
        <!-- define a separate click handler to close manually or let form submit close it? 
             If button is inside form method="dialog", it closes. But we need async action. -->
        <button class="btn btn-primary" @click.prevent="if(teamName) { $store.auth.createTeam(teamName); teamName = ''; create_team_modal.close(); }">Create</button>
      </form>
    </div>
  </div>
</dialog>

<dialog id="invite_member_modal" class="modal" x-data="{ email: '' }">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Invite New Member</h3>
    <p class="py-2 text-sm">Send an invitation email to add a member to your organization.</p>
    <div class="py-4">
        <input type="email" placeholder="Email Address" class="input input-bordered w-full" x-model="email" @keydown.enter.prevent="if(email) { $store.auth.inviteMember($store.auth.currentTeam.$id, email); email = ''; invite_member_modal.close(); }" />
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Cancel</button>
        <button class="btn btn-primary" @click.prevent="if(email) { $store.auth.inviteMember($store.auth.currentTeam.$id, email); email = ''; invite_member_modal.close(); }">Send Invite</button>
      </form>
    </div>
  </div>
</dialog>
